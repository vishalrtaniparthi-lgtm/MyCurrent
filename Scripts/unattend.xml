<?xml version="1.0" encoding="UTF-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend">

  <!-- ═══════════════════════════════════════════════════════
       specialize pass — runs before first boot, as SYSTEM.
       Handles: hostname, domain join, static IP, DNS, RDP.
       ═══════════════════════════════════════════════════════ -->
  <settings pass="specialize">

    <!-- Computer name and org info -->
    <component
      xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      name="Microsoft-Windows-Shell-Setup"
      processorArchitecture="amd64"
      publicKeyToken="31bf3856ad364e35"
      language="neutral"
      versionScope="nonSxS">
      <ComputerName>${vm_name}</ComputerName>
      <RegisteredOrganization>Corp Name Here</RegisteredOrganization>
      <RegisteredOwner>ITOS</RegisteredOwner>
      <TimeZone>Central Standard Time</TimeZone>
    </component>

    <!-- Domain join -->
    <component
      xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      name="Microsoft-Windows-UnattendedJoin"
      processorArchitecture="amd64"
      publicKeyToken="31bf3856ad364e35"
      language="neutral"
      versionScope="nonSxS">
      <Identification>
        <JoinDomain>${domain_name}</JoinDomain>
        <UnsecureJoin>false</UnsecureJoin>
        <Credentials>
          <Domain>${domain_name}</Domain>
          <Username>${domain_user}</Username>
          <Password>${domain_pass_xml}</Password>
        </Credentials>
      </Identification>
    </component>

    <!-- Static IP assignment — DHCP disabled -->
    <component
      xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      name="Microsoft-Windows-TCPIP"
      processorArchitecture="amd64"
      publicKeyToken="31bf3856ad364e35"
      language="neutral"
      versionScope="nonSxS">
      <Interfaces>
        <Interface wcm:action="add">
          <Identifier>Ethernet</Identifier>
          <Ipv4Settings>
            <DhcpEnabled>false</DhcpEnabled>
            <RouterDiscoveryEnabled>false</RouterDiscoveryEnabled>
            <Metric>30</Metric>
          </Ipv4Settings>
          <UnicastIpAddresses>
            <IpAddress wcm:action="add" wcm:keyValue="1">${static_ip}/${prefix}</IpAddress>
          </UnicastIpAddresses>
          <Routes>
            <Route wcm:action="add">
              <Identifier>10</Identifier>
              <Metric>20</Metric>
              <NextHopAddress>${gateway}</NextHopAddress>
              <Prefix>0.0.0.0/0</Prefix>
            </Route>
          </Routes>
        </Interface>
      </Interfaces>
    </component>

    <!-- DNS client configuration -->
    <component
      xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      name="Microsoft-Windows-DNS-Client"
      processorArchitecture="amd64"
      publicKeyToken="31bf3856ad364e35"
      language="neutral"
      versionScope="nonSxS">
      <UseDomainNameDevolution>true</UseDomainNameDevolution>
      <DNSDomain>${domain_name}</DNSDomain>
      <Interfaces>
        <Interface wcm:action="add">
          <Identifier>Ethernet</Identifier>
          <DNSDomain>${domain_name}</DNSDomain>
          <DNSServerSearchOrder>
            <IpAddress wcm:action="add" wcm:keyValue="1">${dns1}</IpAddress>
            <IpAddress wcm:action="add" wcm:keyValue="2">${dns2}</IpAddress>
          </DNSServerSearchOrder>
          <EnableAdapterDomainNameRegistration>true</EnableAdapterDomainNameRegistration>
          <DisableDynamicUpdate>false</DisableDynamicUpdate>
        </Interface>
      </Interfaces>
    </component>

    <!-- Enable Remote Desktop (RDP) -->
    <component
      xmlns=""
      name="Microsoft-Windows-TerminalServices-LocalSessionManager"
      publicKeyToken="31bf3856ad364e35"
      language="neutral"
      versionScope="nonSxS"
      processorArchitecture="amd64">
      <fDenyTSConnections>false</fDenyTSConnections>
    </component>

    <component
      xmlns=""
      name="Microsoft-Windows-TerminalServices-RDP-WinStationExtensions"
      publicKeyToken="31bf3856ad364e35"
      language="neutral"
      versionScope="nonSxS"
      processorArchitecture="amd64">
      <!-- 0 = allow NLA-less connections; set to 1 to require NLA -->
      <UserAuthentication>0</UserAuthentication>
    </component>

    <!-- Firewall — allow only RDP and WinRM; do NOT disable all profiles -->
    <component
      xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      name="Networking-MPSSVC-Svc"
      processorArchitecture="amd64"
      publicKeyToken="31bf3856ad364e35"
      language="neutral"
      versionScope="nonSxS">
      <FirewallGroups>
        <!-- Allow Remote Desktop through all profiles -->
        <FirewallGroup wcm:action="add" wcm:keyValue="RemoteDesktop">
          <Active>true</Active>
          <Profile>all</Profile>
          <Group>@FirewallAPI.dll,-28752</Group>
        </FirewallGroup>
        <!-- Allow Windows Remote Management (WinRM) through all profiles -->
        <FirewallGroup wcm:action="add" wcm:keyValue="WinRM">
          <Active>true</Active>
          <Profile>all</Profile>
          <Group>@FirewallAPI.dll,-30267</Group>
        </FirewallGroup>
      </FirewallGroups>
      <!-- NOTE: Firewall profiles are left ENABLED (default).
           Only specific rules above are opened. This is safer
           than disabling all profiles as the previous version did. -->
    </component>

  </settings>

  <!-- ═══════════════════════════════════════════════════════
       oobeSystem pass — runs during first boot as Administrator.
       Handles: admin password, auto-logon, first-run commands.
       ═══════════════════════════════════════════════════════ -->
  <settings pass="oobeSystem">

    <component
      xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      name="Microsoft-Windows-Shell-Setup"
      processorArchitecture="amd64"
      publicKeyToken="31bf3856ad364e35"
      language="neutral"
      versionScope="nonSxS">

      <!-- Local Administrator password -->
      <UserAccounts>
        <AdministratorPassword>
          <Value>${admin_password_xml}</Value>
          <PlainText>true</PlainText>
        </AdministratorPassword>
      </UserAccounts>

      <!-- Auto-logon: 1 logon only, to run FirstLogonCommands -->
      <AutoLogon>
        <Password>
          <Value>${admin_password_xml}</Value>
          <PlainText>true</PlainText>
        </Password>
        <Enabled>true</Enabled>
        <LogonCount>1</LogonCount>
        <Username>Administrator</Username>
      </AutoLogon>

      <!-- First logon commands — executed in order -->
      <FirstLogonCommands>

        <!-- Order 1: Enable WinRM HTTP (port 5985) for initial Ansible bootstrap -->
        <SynchronousCommand wcm:action="add">
          <Order>1</Order>
          <Description>Enable WinRM HTTP quickconfig</Description>
          <RequiresUserInput>false</RequiresUserInput>
          <CommandLine>cmd.exe /c winrm quickconfig -quiet -force</CommandLine>
        </SynchronousCommand>

        <!-- Order 2: Allow unencrypted WinRM temporarily for initial connection -->
        <SynchronousCommand wcm:action="add">
          <Order>2</Order>
          <Description>Allow WinRM unencrypted for bootstrap</Description>
          <RequiresUserInput>false</RequiresUserInput>
          <CommandLine>cmd.exe /c winrm set winrm/config/service @{AllowUnencrypted="true"}</CommandLine>
        </SynchronousCommand>

        <!-- Order 3: Allow Basic auth temporarily for bootstrap -->
        <SynchronousCommand wcm:action="add">
          <Order>3</Order>
          <Description>Allow WinRM Basic auth for bootstrap</Description>
          <RequiresUserInput>false</RequiresUserInput>
          <CommandLine>cmd.exe /c winrm set winrm/config/service/auth @{Basic="true"}</CommandLine>
        </SynchronousCommand>

        <!-- Order 4: Open WinRM HTTP port 5985 in firewall -->
        <SynchronousCommand wcm:action="add">
          <Order>4</Order>
          <Description>Open WinRM HTTP port 5985 in firewall</Description>
          <RequiresUserInput>false</RequiresUserInput>
          <CommandLine>cmd.exe /c netsh advfirewall firewall add rule name="WinRM HTTP 5985" dir=in action=allow protocol=TCP localport=5985</CommandLine>
        </SynchronousCommand>

        <!-- Order 5: Open WinRM HTTPS port 5986 in firewall -->
        <SynchronousCommand wcm:action="add">
          <Order>5</Order>
          <Description>Open WinRM HTTPS port 5986 in firewall</Description>
          <RequiresUserInput>false</RequiresUserInput>
          <CommandLine>cmd.exe /c netsh advfirewall firewall add rule name="WinRM HTTPS 5986" dir=in action=allow protocol=TCP localport=5986</CommandLine>
        </SynchronousCommand>

        <!-- Order 6: Set account lockout threshold -->
        <SynchronousCommand wcm:action="add">
          <Order>6</Order>
          <Description>Set account lockout policy to 3 attempts</Description>
          <RequiresUserInput>false</RequiresUserInput>
          <CommandLine>cmd.exe /c net accounts /lockoutthreshold:3</CommandLine>
        </SynchronousCommand>

        <!-- Order 99: Log off Administrator — Ansible will handle all post-boot tasks -->
        <SynchronousCommand wcm:action="add">
          <Order>99</Order>
          <Description>Log off Administrator after first-run commands</Description>
          <RequiresUserInput>false</RequiresUserInput>
          <CommandLine>cmd.exe /c logoff</CommandLine>
        </SynchronousCommand>

        <!--
          NOTE: No PostBoot scheduled task registered here.
          All post-boot configuration (paging disk, IPv6, services)
          is handled by Ansible (ansible/roles/windows-postboot)
          which also configures WinRM HTTPS (port 5986) on first connect.
        -->

      </FirstLogonCommands>

      <!-- Skip OOBE screens -->
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <SkipMachineOOBE>true</SkipMachineOOBE>
      </OOBE>

    </component>

    <!-- Locale settings -->
    <component
      xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      name="Microsoft-Windows-International-Core"
      processorArchitecture="amd64"
      publicKeyToken="31bf3856ad364e35"
      language="neutral"
      versionScope="nonSxS">
      <InputLocale>en-US</InputLocale>
      <SystemLocale>en-US</SystemLocale>
      <UILanguage>en-US</UILanguage>
      <UILanguageFallback>en-US</UILanguageFallback>
      <UserLocale>en-US</UserLocale>
    </component>

  </settings>

</unattend>
